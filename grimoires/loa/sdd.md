# SDD: Hounfour v8.3.1 Bump — Domain Tag Sanitization Fix & Docker Redeploy

**Version**: 21.0.0
**Date**: 2026-02-28
**Author**: Claude (Architecture), Merlin (Direction)
**Cycle**: cycle-021
**Status**: Draft
**PRD Reference**: PRD v21.0.0 — Hounfour v8.3.1 Bump

> Sources: `app/package.json:23`, `app/src/services/audit-trail-store.ts:1-137`,
> `app/src/services/scoring-path-tracker.ts:28-102`, `deploy/Dockerfile:1-37`,
> Issue #71, loa-hounfour PR #42

---

## 1. Architecture Overview

### 1.1 Change Surface

This is a **dependency-only change** — no application logic is modified. The change surface is:

```
app/package.json                    ← Pin update: v8.3.0 → v8.3.1
app/package-lock.json               ← Regenerated lockfile
app/src/services/audit-trail-store.ts  ← Comment update only (FR-2)
app/tests/integration/              ← New hounfour compat test (FR-4.1)
```

### 1.2 Dependency Graph (Hounfour Integration)

```
app/package.json
  └── @0xhoneyjar/loa-hounfour#v8.3.1
       ├── /commons    ← audit trail primitives
       │   ├── computeAuditEntryHash()
       │   ├── computeChainBoundHash()      ← canonical algorithm
       │   ├── buildDomainTag()             ← CHANGED: now sanitizes dots→hyphens
       │   ├── verifyAuditTrailIntegrity()
       │   ├── validateAuditTimestamp()
       │   ├── AUDIT_TRAIL_GENESIS_HASH
       │   ├── createCheckpoint()
       │   ├── verifyCheckpointContinuity()
       │   └── pruneBeforeCheckpoint()
       ├── /governance ← reputation scoring
       │   ├── computeScoringPathHash()
       │   ├── computeBlendedScore()
       │   └── SCORING_PATH_GENESIS_HASH
       ├── /core       ← protocol types (AccessPolicy, CircuitState)
       ├── /economy    ← economic constraints (checksumAddress)
       ├── /integrity  ← request hashing (computeReqHash)
       └── @noble/hashes (transitive) ← SHA-256 provider
```

### 1.3 Hash Chain Architecture (Epoch Boundary)

```
BEFORE v8.3.1                          AFTER v8.3.1
═══════════════                        ═══════════════

audit-trail-store.ts:                  audit-trail-store.ts:
  Local buildDomainTag()               Local buildDomainTag()
  → "loa-dixie:audit:{type}:v10"      → "loa-dixie:audit:{type}:v10"
  (UNCHANGED — intentional)            (UNCHANGED — kept per FR-2)

scoring-path-tracker.ts:               scoring-path-tracker.ts:
  Canonical buildDomainTag()           Canonical buildDomainTag()
  → potentially unsanitized            → "loa-commons:audit:scoringpathlog:8-2-0"
                                         (dots sanitized to hyphens)

Hash verification:                     Hash verification:
  Stored entries: verify with          Stored entries: verify with
  stored domain_tag (never re-derive)  stored domain_tag (never re-derive)
  → v9 algo for legacy tags            → v9 algo for legacy tags
  → canonical for v10 tags             → canonical for v10 tags
                                       NEW entries use v8.3.1 output format
```

---

## 2. Component Design

### 2.1 Package.json Update

**File**: `app/package.json:23`

```diff
- "@0xhoneyjar/loa-hounfour": "github:0xHoneyJar/loa-hounfour#v8.3.0",
+ "@0xhoneyjar/loa-hounfour": "github:0xHoneyJar/loa-hounfour#v8.3.1",
```

**Lockfile**: Regenerated by `npm install`. Verify `@noble/hashes` version unchanged.

### 2.2 Audit Trail Store — Comment Update

**File**: `app/src/services/audit-trail-store.ts:50-57`

The local `buildDomainTag()` function is kept unchanged. Add decision rationale comment:

```typescript
/**
 * Local buildDomainTag — intentionally retained post-hounfour v8.3.1.
 *
 * Hounfour v8.3.1 introduces deterministic sanitization (dots → hyphens),
 * making this workaround technically optional. However, we keep it because:
 * - 12 migrations store entries with 'v10' domain tags (loa-dixie:audit:*:v10)
 * - Canonical hounfour would produce a different prefix ('loa-commons:audit:')
 * - Changing mid-chain would require re-hashing all stored entries
 * - verifyAuditTrailIntegrity() already handles mixed chains via stored tags
 *
 * Decision: cycle-021, Issue #71, Option A (keep local workaround).
 * @see ADR-006, computeChainBoundHashVersionAware()
 * @since cycle-019 Sprint 121 — T6.3
 * @since cycle-021 — Decision to retain post-v8.3.1
 */
function buildDomainTag(resourceType: string): string {
  return `${DOMAIN_TAG_PREFIX}:${resourceType}:v10`;
}
```

### 2.3 Integration Test — Hounfour v8.3.1 Compatibility

**File**: `app/tests/integration/hounfour-v831-compat.test.ts` (NEW)

Tests the REAL hounfour module (no mocks):

```typescript
// Test suite structure:
describe('hounfour v8.3.1 compatibility', () => {
  test('buildDomainTag sanitizes dots to hyphens');
  test('computeChainBoundHash produces valid SHA-256');
  test('computeAuditEntryHash is deterministic');
  test('verifyAuditTrailIntegrity handles mixed v9/v10 chains');
  test('@noble/hashes version matches expected');
});
```

**Key assertions**:
- `buildDomainTag('ScoringPathLog', '8.2.0')` returns string matching `/^loa-commons:audit:scoringpathlog:8-2-0$/`
- `computeChainBoundHash()` output is 64-char hex string prefixed with `sha256:`
- Version-aware dispatch: legacy tag → v9 algo, canonical tag → canonical algo

### 2.4 Scoring Path Tracker — No Code Change

**File**: `app/src/services/scoring-path-tracker.ts:102`

```typescript
const SCORING_PATH_DOMAIN_TAG = buildDomainTag('ScoringPathLog', '8.2.0');
```

This line uses the CANONICAL `buildDomainTag` from hounfour. After v8.3.1:
- Output changes from potentially unsanitized to `loa-commons:audit:scoringpathlog:8-2-0`
- This is the epoch boundary: new entries get the sanitized format
- Existing entries in memory retain their stored domain tags
- `verifyAuditTrailIntegrity()` reads stored tags, never re-derives

**No code change required.** Existing tests verify chain linking; the integration test (§2.3) validates the new format.

**IMPORTANT — Module-Load-Time Epoch Boundary** *(Flatline BLOCKER)*:
`SCORING_PATH_DOMAIN_TAG` is computed at import time (module-level `const`). After bumping hounfour, a **clean process restart** is required — not hot-reload. Docker deployment naturally provides this. For local dev (`tsx watch`), restart the dev server after `npm install`.

### 2.5 Dual Verification Path — *Flatline BLOCKER*

Two code paths verify audit trail integrity:

| Component | Verification Method | Version-Aware? |
|-----------|-------------------|----------------|
| `audit-trail-store.ts` | Local `computeChainBoundHashVersionAware()` | Yes — dispatches v9 vs canonical |
| `scoring-path-tracker.ts` | Hounfour's `verifyAuditTrailIntegrity()` directly | **Must verify** |

**Risk**: If hounfour's `verifyAuditTrailIntegrity()` assumes canonical-only (no v9 dispatch), pre-bump scoring path entries could fail verification after the bump.

**Mitigation**: The integration test (§2.3) MUST explicitly cover this case:
1. Create a scoring path chain with entries using both old and new domain tag formats
2. Call `verifyAuditTrailIntegrity()` on the mixed chain
3. Verify it returns `valid: true`

If hounfour's verification is NOT version-aware, the scoring path tracker's existing entries are safe because they all use the same algorithm (canonical via hounfour). The epoch boundary means NEW entries get a different domain tag string, but the algorithm (canonical) is the same — only the input to the hash changes, and each entry stores its own domain tag.

---

## 3. Build & Deploy Design

### 3.1 Preflight Check

```bash
# Verify tag exists before attempting npm install
git ls-remote https://github.com/0xHoneyJar/loa-hounfour.git refs/tags/v8.3.1
```

### 3.1.1 Dev Server Restart Note *(Flatline BLOCKER resolution)*

After running `npm install` to bump hounfour, **restart the dev server** (`npm run dev`). Do NOT rely on `tsx watch` hot-reload — the module-level `SCORING_PATH_DOMAIN_TAG` constant needs a fresh process to pick up the new `buildDomainTag` output.

### 3.2 Local Build Pipeline

```bash
cd app
npm install                          # Update lockfile
npm run typecheck                    # Type compatibility
npm run test                         # Unit + integration tests
npm run build                        # TypeScript compilation
```

### 3.3 Docker Build

```bash
docker build -f deploy/Dockerfile -t dixie-bff:v8.3.1-bump .
```

The Dockerfile (`deploy/Dockerfile:1-37`) uses multi-stage build:
1. **deps** (line 6-8): `npm ci --omit=dev` — resolves hounfour v8.3.1 from lockfile
2. **build** (line 11-21): `npm ci --include=dev` + `tsc` — compiles with v8.3.1 types
3. **runtime** (line 24-37): Runs as `dixie` user, healthcheck on port 3001

### 3.4 Staging Deploy (GATE-STAGING)

If infrastructure access available:
```bash
# Push to ECR
aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin $ECR_REPO
docker tag dixie-bff:v8.3.1-bump $ECR_REPO:latest
docker push $ECR_REPO:latest

# Force new ECS deployment
aws ecs update-service --cluster arrakis-staging --service dixie-bff --force-new-deployment

# Verify health
curl -s https://dixie.0xhoneyjar.xyz/health | jq .
```

---

## 4. Test Strategy

### 4.1 Test Layers

| Layer | Command | What It Validates |
|-------|---------|-------------------|
| Types | `npm run typecheck` | All hounfour imports type-compatible |
| Unit | `npm run test` | Audit trail, scoring path, reputation, governance |
| Integration | `vitest run tests/integration/hounfour-v831-compat.test.ts` | Real hounfour behavior (no mocks) |
| Docker | `docker build` | Dependency resolution in container |
| E2E | `npm run test:e2e` (optional) | Full stack with PG/Redis/NATS |

### 4.2 Critical Test Files

| File | Tests | Risk |
|------|-------|------|
| `tests/unit/audit-trail-store.test.ts` | Chain linking, version-aware dispatch | Medium |
| `tests/unit/audit-trail-version-aware.test.ts` | Legacy vs canonical algo dispatch | High |
| `tests/unit/scoring-path-tracker.test.ts` | Hash chain, checkpoint, integrity | High |
| `tests/integration/hounfour-v831-compat.test.ts` | Real hounfour v8.3.1 behavior | New |

### 4.3 Transitive Dependency Verification

```typescript
// In hounfour-v831-compat.test.ts:
import { resolve } from 'path';
import { readFileSync } from 'fs';

test('@noble/hashes version unchanged', () => {
  const lockfile = JSON.parse(readFileSync(resolve(__dirname, '../../package-lock.json'), 'utf-8'));
  const nobleVersion = lockfile.packages?.['node_modules/@noble/hashes']?.version
    ?? lockfile.dependencies?.['@noble/hashes']?.version;
  // Should match the version from v8.3.0
  expect(nobleVersion).toBe('2.0.1');
});
```

---

## 5. Rollback Strategy

| Scenario | Detection | Action |
|----------|-----------|--------|
| Tests fail post-bump | `npm run test` exits non-zero | Revert `package.json` and `package-lock.json` to v8.3.0 |
| Docker build fails | `docker build` exits non-zero | Same revert |
| Staging health fails | `/api/health` returns non-200 | Rollback ECS task definition to previous revision |
| Audit trail integrity fails | Logs show `verifyAuditTrailIntegrity` error | Rollback Docker image; preserve logs for post-mortem |

Git rollback:
```bash
git checkout HEAD -- app/package.json app/package-lock.json
npm ci
```

---

## 6. Security Considerations

- **Hash algorithm unchanged**: SHA-256 via `@noble/hashes` — no cryptographic changes
- **Domain tag sanitization**: v8.3.1 adds input validation (grammar, length bounds) — security improvement
- **No new attack surface**: This is a dependency update, not a feature addition
- **Audit trail integrity preserved**: Version-aware dispatch ensures backward compatibility

### 6.1 Red Team Mitigations (Top 3)

**RT-1: Pin to commit SHA, not tag** *(blocks ATTACK-1: Git Tag Mutation)*

After verifying the v8.3.1 tag, resolve it to its commit SHA and pin to that:
```bash
git ls-remote https://github.com/0xHoneyJar/loa-hounfour.git refs/tags/v8.3.1
# Use the returned SHA in package.json
```
This prevents tag force-push attacks. The tag reference is used for initial resolution only; the lockfile stores the commit SHA for reproducibility.

**RT-2: Validate resourceType in AuditTrailStore.append()** *(blocks ATTACK-3: Domain Tag Injection)*

Add input validation before `buildDomainTag()`:
```typescript
const VALID_RESOURCE_TYPE = /^[a-z][a-z0-9_-]*$/;
if (!VALID_RESOURCE_TYPE.test(resourceType)) {
  throw new Error(`Invalid resourceType: ${resourceType.slice(0, 50)}`);
}
```
This prevents colon injection that could confuse `isLegacyDomainTag()` dispatch.

**RT-3: Immutable Docker image tags** *(blocks ATTACK-8: ECR :latest Overwrite)*

Tag images with both `:latest` and an immutable tag:
```bash
docker tag dixie-bff:build $ECR_REPO:latest
docker tag dixie-bff:build $ECR_REPO:$(git rev-parse --short HEAD)
```
Record the image digest for rollback.

---

## 7. Files Changed Summary

| File | Change Type | Description |
|------|------------|-------------|
| `app/package.json` | Edit | Pin v8.3.0 → v8.3.1 |
| `app/package-lock.json` | Regenerated | Updated lockfile |
| `app/src/services/audit-trail-store.ts` | Comment | Decision rationale for local buildDomainTag |
| `app/tests/integration/hounfour-v831-compat.test.ts` | New | Real hounfour compatibility test |
