# Cross-Repository Invariant Declarations
# Social contract expressed as verifiable properties (Bridgebuilder Part II)
#
# These invariants span the Loa metering pipeline (pricing → budget → ledger)
# and the Hounfour runtime bridge. Each invariant is verified by specific
# functions in the codebase, referenced by repo:file:symbol.

schema_version: 1
protocol: loa-hounfour@8.2.0

invariants:
  - id: INV-001
    description: "Conservation — no micro-USD is created or destroyed during cost calculation. The fundamental economic invariant of the metering pipeline."
    severity: critical
    category: conservation
    properties:
      - "cost_micro * 1_000_000 + remainder == tokens * price_per_million"
      - "sum(input_costs) == sum(distributed_costs) + sum(remainders)"
      - "For any (tokens, price) where tokens * price <= MAX_SAFE_PRODUCT: divmod preserves total"
    verified_in:
      - repo: loa
        file: ".claude/adapters/loa_cheval/metering/pricing.py"
        symbol: "calculate_cost_micro"
        note: "Integer divmod ensures cost*1M + remainder == tokens*price"
      - repo: loa
        file: ".claude/adapters/loa_cheval/metering/pricing.py"
        symbol: "RemainderAccumulator"
        note: "Carries sub-micro-USD fractions across requests without loss"
      - repo: loa
        file: ".claude/adapters/loa_cheval/metering/pricing.py"
        symbol: "calculate_total_cost"
        note: "Sums component costs preserving conservation across input/output/reasoning"
      - repo: loa
        file: ".claude/adapters/tests/test_conservation_invariant.py"
        symbol: "TestConservationPropertyRange"
        note: "Range-based verification across 156 token/price sample pairs"

  - id: INV-002
    description: "Non-negative spend — daily_spend >= 0 at all times. The ledger never records negative costs."
    severity: critical
    category: bounded
    properties:
      - "daily_spend >= 0 at all times"
      - "read_daily_spend() >= 0 for any valid ledger file"
      - "No ledger entry has cost_micro_usd < 0"
    verified_in:
      - repo: loa
        file: ".claude/adapters/loa_cheval/metering/budget.py"
        symbol: "BudgetEnforcer"
        note: "pre_call_atomic reserves non-negative amounts only"
      - repo: loa
        file: ".claude/adapters/loa_cheval/metering/ledger.py"
        symbol: "update_daily_spend"
        note: "Adds positive cost to daily counter via flock-protected read-modify-write"
      - repo: loa
        file: ".claude/adapters/tests/test_conservation_invariant.py"
        symbol: "TestDailySpendNonNegative"
        note: "Verifies initial zero and monotonic increase"

  - id: INV-003
    description: "Deduplication — interaction_id uniqueness prevents double-counting. Each Deep Research interaction is recorded in the ledger at most once."
    severity: important
    category: idempotent
    properties:
      - "len(unique(interaction_ids)) == len(ledger_entries_for_interactions)"
      - "post_call with duplicate interaction_id is a no-op"
    verified_in:
      - repo: loa
        file: ".claude/adapters/loa_cheval/metering/budget.py"
        symbol: "BudgetEnforcer"
        note: "post_call tracks seen interaction_ids and skips duplicates"
      - repo: loa
        file: ".claude/adapters/loa_cheval/metering/ledger.py"
        symbol: "record_cost"
        note: "Delegates to append_ledger which writes atomically"
      - repo: loa
        file: ".claude/adapters/tests/test_budget_fallback.py"
        symbol: "TestAtomicPreCallPostCallZeroCost"
        note: "Verifies interaction_id deduplication in post_call"

  - id: INV-004
    description: "Budget monotonicity — daily spend counter only increases within a day, never decremented. Prevents budget evasion through counter manipulation."
    severity: critical
    category: monotonicity
    properties:
      - "daily_spend(t+1) >= daily_spend(t) within the same calendar day"
      - "update_daily_spend only adds, never subtracts"
    verified_in:
      - repo: loa
        file: ".claude/adapters/loa_cheval/metering/budget.py"
        symbol: "BudgetEnforcer"
        note: "post_call always adds positive cost to daily spend"
      - repo: loa
        file: ".claude/adapters/loa_cheval/metering/ledger.py"
        symbol: "update_daily_spend"
        note: "Adds entry_cost_micro to existing counter (never subtracts)"
      - repo: loa
        file: ".claude/adapters/tests/test_conservation_invariant.py"
        symbol: "TestDailySpendNonNegative"
        note: "test_spend_increases_monotonically verifies monotonic increase"

  - id: INV-005
    description: "Trust boundary — no model exceeds its trust_scopes at runtime. The resolver enforces that agent bindings respect declared trust boundaries."
    severity: critical
    category: bounded
    properties:
      - "For all agents: resolved_model.trust_scopes <= declared_trust_scopes"
      - "native_runtime agents cannot be overridden to remote models"
      - "Capability requirements must be satisfied by the resolved model"
    verified_in:
      - repo: loa
        file: ".claude/adapters/loa_cheval/routing/resolver.py"
        symbol: "resolve_execution"
        note: "Checks native_runtime guard and capability requirements"
      - repo: loa
        file: ".claude/adapters/loa_cheval/routing/resolver.py"
        symbol: "validate_bindings"
        note: "Pre-flight validation that all agent bindings are satisfiable"
      - repo: loa
        file: ".claude/data/model-permissions.yaml"
        symbol: "model_permissions"
        note: "Declares trust_scopes for all registered models"
      - repo: loa
        file: ".claude/adapters/tests/test_trust_scopes.py"
        symbol: "TestTrustScopesSchema"
        note: "Validates all models have complete trust_scopes declarations"

  - id: INV-006
    description: "Feedback dampening — model_performance feedback loop is bounded by EMA dampening. Score cannot jump more than alpha_max * delta per observation, preventing runaway convergence or death spirals in the autopoietic loop."
    severity: important
    category: bounded
    properties:
      - "For any observation: |dampened_score - old_score| <= ALPHA_MAX * |new_score - old_score|"
      - "alpha = ALPHA_MIN + (ALPHA_MAX - ALPHA_MIN) * min(1, sample_count / RAMP)"
      - "Cold start (null old_score) returns new_score directly (no dampening)"
      - "Repeated identical observations converge to that value"
    verified_in:
      - repo: loa-dixie
        file: "app/src/services/reputation-service.ts"
        symbol: "computeDampenedScore"
        note: "Pure EMA function with alpha ramp from ALPHA_MIN to ALPHA_MAX"
      - repo: loa-dixie
        file: "app/src/services/reputation-service.ts"
        symbol: "handleModelPerformance"
        note: "Uses computeDampenedScore instead of raw score assignment"
      - repo: loa-dixie
        file: "app/src/services/reputation-service.ts"
        symbol: "handleQualitySignal"
        note: "Consistent dampening across both score-update paths"
      - repo: loa-dixie
        file: "app/src/services/__tests__/feedback-dampening.test.ts"
        symbol: "computeDampenedScore"
        note: "8 test cases verifying EMA properties, convergence, and outlier dampening"

  - id: INV-007
    description: "Session-scoped governance — MutationLog is explicitly session-scoped with unique sessionId. Governance mutations are traceable to their originating session."
    severity: important
    category: traceability
    properties:
      - "Each MutationLog instance has a unique sessionId (UUID)"
      - "sessionId is immutable within a session (stable across appends)"
      - "getGovernedState().session_id links governance metadata to the active session"
    verified_in:
      - repo: loa-dixie
        file: "app/src/services/governance-mutation.ts"
        symbol: "MutationLog"
        note: "Session-scoped with readonly sessionId, optional MutationLogPersistence"
      - repo: loa-dixie
        file: "app/src/services/__tests__/governance-mutation.test.ts"
        symbol: "MutationLog session lifecycle"
        note: "Verifies sessionId uniqueness, stability, and governed state integration"

  - id: INV-008
    description: "Governance isomorphism — all governed resources implement the GovernedResource<T> protocol with identity, state transitions, invariant verification, and tamper-evident audit trail. The Kubernetes CRD moment: every governed resource in the ecosystem shares one governance primitive."
    severity: important
    category: structural
    properties:
      - "Every GovernedResource has resourceId, resourceType (identity)"
      - "Every GovernedResource exposes current state and monotonic version"
      - "transition(event, actorId) returns TransitionResult with success/failure discrimination"
      - "verify(invariantId) returns InvariantResult with satisfied/detail"
      - "verifyAll() covers all declared invariants for the resource"
      - "auditTrail is Readonly<AuditTrail> with hash chain integrity"
      - "mutationLog is ReadonlyArray<GovernanceMutation> with actor attribution"
      - "≥2 resource types implement the protocol (reputation, scoring-path)"
    verified_in:
      - repo: loa-dixie
        file: "app/src/services/governed-resource.ts"
        symbol: "GovernedResource<TState, TEvent, TInvariant>"
        note: "Interface definition with GovernedResourceBase abstract class"
      - repo: loa-dixie
        file: "app/src/services/reputation-service.ts"
        symbol: "ReputationService implements GovernedResource"
        note: "Reputation resource with INV-006 (dampening bounds) and INV-007 (session scope)"
      - repo: loa-dixie
        file: "app/src/services/scoring-path-tracker.ts"
        symbol: "ScoringPathTracker implements GovernedResource"
        note: "Scoring path resource with chain_integrity, cross_chain_consistency, checkpoint_coverage"
      - repo: loa-dixie
        file: "app/src/services/governor-registry.ts"
        symbol: "GovernorRegistry.verifyAllResources"
        note: "System-level verification across all registered GovernedResource instances"
      - repo: loa-dixie
        file: "app/src/services/__tests__/autopoietic-loop-v2.test.ts"
        symbol: "GovernedResource.verifyAll() covers all resources"
        note: "Integration test proving both implementations satisfy all invariants"

  - id: INV-009
    description: "Knowledge freshness — freshness_score decreases monotonically between ingestion events via exponential decay (lambda = 0.023, ~30 day half-life). Re-ingestion resets score to 1.0."
    severity: important
    category: bounded
    properties:
      - "freshness_score(t+1) <= freshness_score(t) when no ingestion event occurs between t and t+1"
      - "score(t) = exp(-lambda * days_since_refresh) where lambda = 0.023"
      - "Re-ingestion resets score to 1.0 and state to 'fresh'"
    verified_in:
      - repo: loa-dixie
        file: "app/src/services/knowledge-governor.ts"
        symbol: "computeFreshnessDecay"
        note: "Exponential decay computation with configurable lambda"
      - repo: loa-dixie
        file: "app/src/services/knowledge-governor.ts"
        symbol: "verifyFreshnessBound"
        note: "Invariant checker verifies monotonic decay between ingestion events"
      - repo: loa-dixie
        file: "app/tests/unit/knowledge-governor.test.ts"
        symbol: "INV-009 freshness bound"
        note: "Tests decay computation, state transitions, and re-ingestion reset"

  - id: INV-010
    description: "Citation integrity — citation count does not exceed the number of known sources in the corpus. Ensures citation claims are bounded by available evidence."
    severity: important
    category: referential
    properties:
      - "item.citation_count <= knownSources.size"
      - "verifyCitationIntegrity() returns satisfied: false when citation_count exceeds known source count"
    verified_in:
      - repo: loa-dixie
        file: "app/src/services/knowledge-governor.ts"
        symbol: "verifyCitationIntegrity"
        note: "Checks citation_count does not exceed knownSources.size"
      - repo: loa-dixie
        file: "app/tests/unit/knowledge-governor.test.ts"
        symbol: "INV-010 citation integrity"
        note: "Tests satisfied and violation cases"

  - id: INV-011
    description: "Chain integrity — computeChainBoundHash(entry, domainTag, previousHash) is deterministic and tamper-evident. Recomputing any entry's hash from its content and predecessor must match the stored hash."
    severity: critical
    category: integrity
    properties:
      - "For all entries e: recompute(e.content, e.previous_hash) == e.entry_hash"
      - "Modifying content OR previous_hash invalidates entry_hash"
      - "Chain is verifiable from genesis to tip in O(n) time"
    verified_in:
      - repo: loa-dixie
        file: "app/src/services/audit-trail-store.ts"
        symbol: "computeChainBoundHash"
        note: "Chain-bound hash: includes previous_hash in computation"
      - repo: loa-dixie
        file: "app/src/services/audit-trail-store.ts"
        symbol: "verifyIntegrity"
        note: "Walks chain from genesis, recomputes each hash"
      - repo: loa-dixie
        file: "app/src/services/scoring-path-tracker.ts"
        symbol: "verifyIntegrity"
        note: "Independent hash chain verification for scoring path"
      - repo: loa-dixie
        file: "app/tests/unit/audit-trail-store.test.ts"
        symbol: "verifyIntegrity"
        note: "Tests chain integrity and tamper detection"

  - id: INV-012
    description: "Three-witness quorum — the GovernorRegistry maintains >= 3 registered resource types, proving that the governance abstraction generalizes across independent domains rather than being incidental to a single use case."
    severity: important
    category: structural
    properties:
      - "governorRegistry.size >= 3 after initialization"
      - "At least 3 distinct resourceType values registered"
      - "verifyAllGovernors() returns health for all 3+ witnesses"
    verified_in:
      - repo: loa-dixie
        file: "app/src/services/governor-registry.ts"
        symbol: "verifyAllGovernors"
        note: "System-level verification across all registered governors"
      - repo: loa-dixie
        file: "app/tests/integration/governance-three-witness.test.ts"
        symbol: "registers all three witnesses"
        note: "Integration test proving 3 governors registered with health"
      - repo: loa-dixie
        file: "app/src/services/__tests__/autopoietic-loop-v2.test.ts"
        symbol: "GovernedResource.verifyAll()"
        note: "Proves all resource implementations satisfy invariants"

  - id: INV-013
    description: "Reputation conservation — blended_score at time T must be derivable from collection_score, personal_score, sample_count, and pseudo_count at time T via the Bayesian formula. The reconstructAggregateFromEvents() function is the formal proof: replaying events reconstructs the score. If blended_score diverges from the formula, the aggregate is corrupt."
    severity: critical
    category: conservation
    properties:
      - "blended_score == (pseudo_count * collection_score + sample_count * personal_score) / (pseudo_count + sample_count)"
      - "When personal_score is null (cold agent): blended_score == collection_score"
      - "reconstructAggregateFromEvents(events).blended_score == computeBlendedScore(personal, collection, n, k) for the same inputs"
      - "buildUpdatedAggregate always recomputes blended_score from the Bayesian formula (no stale cache)"
    verified_in:
      - repo: loa-dixie
        file: "app/src/services/reputation-service.ts"
        symbol: "reconstructAggregateFromEvents"
        note: "Event-sourced reconstruction: replays events and recomputes blended_score via computeBlendedScore (line 1084)"
      - repo: loa-dixie
        file: "app/src/services/reputation-service.ts"
        symbol: "ReputationService.buildUpdatedAggregate"
        note: "Every event path recomputes blended_score from the Bayesian formula (line 773)"
      - repo: loa-hounfour
        file: "src/governance/reputation-aggregate.ts"
        symbol: "computeBlendedScore"
        note: "Canonical Bayesian blend: (k * q_collection + n * q_personal) / (k + n) — the conservation equation"
      - repo: loa-dixie
        file: "app/src/services/__tests__/autopoietic-loop.test.ts"
        symbol: "reconstructAggregateFromEvents"
        note: "Verifies reconstruction from model_performance, mixed events, and empty streams"
      - repo: loa-dixie
        file: "app/tests/unit/reputation-evolution.test.ts"
        symbol: "reconstructAggregateFromEvents (stub)"
        note: "Verifies warming aggregate, sample_count, and contract_version from quality_signal events"

  - id: INV-014
    description: "Fleet tier limit enforcement — active agent count never exceeds conviction tier limit"
    severity: critical
    category: fleet-governance
    properties:
      - "active_count_per_operator <= tier_limit"
      - "FleetGovernor.admitAndInsert() uses SELECT FOR UPDATE to serialize concurrent checks"
      - "canSpawn() pre-check uses cached count as fast-reject gate"
    verified_in:
      - repo: loa-dixie
        file: "app/src/services/__tests__/fleet-governor.test.ts"
        symbol: "FleetGovernor.admitAndInsert"
        note: "Verifies SpawnDeniedError on limit reached and correct transaction sequence"
      - repo: loa-dixie
        file: "app/src/services/__tests__/fleet-invariants.test.ts"
        symbol: "INV-014: Tier limit enforcement"
        note: "Integration test across governor admission, tier changes, and invariant verification"

  - id: INV-015
    description: "Cancelled tasks never retried — cancelled status has no outgoing transitions"
    severity: high
    category: fleet-lifecycle
    properties:
      - "VALID_TRANSITIONS['cancelled'] is empty array"
      - "TERMINAL_STATUSES includes 'cancelled'"
      - "RetryEngine.canRetry() returns false for cancelled tasks"
    verified_in:
      - repo: loa-dixie
        file: "app/src/services/__tests__/task-registry.test.ts"
        symbol: "VALID_TRANSITIONS constant"
        note: "Verifies cancelled has empty transition array and is terminal"
      - repo: loa-dixie
        file: "app/src/services/__tests__/retry-engine.test.ts"
        symbol: "canRetry()"
        note: "Verifies canRetry returns false for cancelled tasks"
      - repo: loa-dixie
        file: "app/src/services/__tests__/fleet-invariants.test.ts"
        symbol: "INV-015: Cancelled tasks never retried"
        note: "Cross-component verification: state machine + RetryEngine + FleetGovernor"

  - id: INV-016
    description: "Tier downgrade safe — cannot spawn above new tier limit"
    severity: high
    category: fleet-governance
    properties:
      - "canSpawn checks current tier limit, not historical"
      - "admitAndInsert uses provided tier parameter, not cached tier"
      - "TIER_CHANGED event updates state to reflect new limit"
    verified_in:
      - repo: loa-dixie
        file: "app/src/services/__tests__/fleet-governor.test.ts"
        symbol: "INV-016: tier downgrade cannot spawn above new limit"
        note: "Verifies verify(INV-016) detects violation after TIER_CHANGED to lower tier"
      - repo: loa-dixie
        file: "app/src/services/__tests__/fleet-invariants.test.ts"
        symbol: "INV-016: Tier downgrade safe"
        note: "Integration test across admitAndInsert, TIER_CHANGED, and canSpawn"

  - id: INV-017
    description: "Retry count bounded — retryCount never exceeds maxRetries"
    severity: high
    category: fleet-lifecycle
    properties:
      - "retry_count < max_retries guarded by DB WHERE clause in recordFailure()"
      - "RetryEngine.canRetry() returns false when retryCount >= maxRetries"
      - "RetryEngine.attemptRetry() transitions to abandoned when budget exhausted"
    verified_in:
      - repo: loa-dixie
        file: "app/src/services/__tests__/task-registry.test.ts"
        symbol: "TaskRegistry — Failure Recording"
        note: "Verifies WHERE retry_count < max_retries guard and null return at max"
      - repo: loa-dixie
        file: "app/src/services/__tests__/retry-engine.test.ts"
        symbol: "canRetry() / attemptRetry()"
        note: "Verifies budget exhaustion logic and abandoned transition"
      - repo: loa-dixie
        file: "app/src/services/__tests__/fleet-invariants.test.ts"
        symbol: "INV-017: Retry count bounded"
        note: "Cross-component verification: TaskRegistry atomic guard + RetryEngine budget check"

  - id: INV-018
    description: "Notification guarantee — notification record inserted before delivery attempt"
    severity: medium
    category: fleet-observability
    properties:
      - "INSERT INTO fleet_notifications before any delivery HTTP call"
      - "Record exists even if delivery fails (crash-safe auditability)"
      - "Record updated with delivery outcome after attempt"
    verified_in:
      - repo: loa-dixie
        file: "app/src/services/__tests__/notification-service.test.ts"
        symbol: "INV-018"
        note: "Verifies INSERT before fetch and record creation on delivery failure"
      - repo: loa-dixie
        file: "app/src/services/__tests__/fleet-invariants.test.ts"
        symbol: "INV-018: Notification guarantee"
        note: "Integration test verifying insert-before-delivery ordering and update after delivery"
