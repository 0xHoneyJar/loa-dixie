# Cross-Repository Invariant Declarations
# Social contract expressed as verifiable properties (Bridgebuilder Part II)
#
# These invariants span the Loa metering pipeline (pricing → budget → ledger)
# and the Hounfour runtime bridge. Each invariant is verified by specific
# functions in the codebase, referenced by repo:file:symbol.

schema_version: 1
protocol: loa-hounfour@8.2.0

invariants:
  - id: INV-001
    description: "Conservation — no micro-USD is created or destroyed during cost calculation. The fundamental economic invariant of the metering pipeline."
    severity: critical
    category: conservation
    properties:
      - "cost_micro * 1_000_000 + remainder == tokens * price_per_million"
      - "sum(input_costs) == sum(distributed_costs) + sum(remainders)"
      - "For any (tokens, price) where tokens * price <= MAX_SAFE_PRODUCT: divmod preserves total"
    verified_in:
      - repo: loa
        file: ".claude/adapters/loa_cheval/metering/pricing.py"
        symbol: "calculate_cost_micro"
        note: "Integer divmod ensures cost*1M + remainder == tokens*price"
      - repo: loa
        file: ".claude/adapters/loa_cheval/metering/pricing.py"
        symbol: "RemainderAccumulator"
        note: "Carries sub-micro-USD fractions across requests without loss"
      - repo: loa
        file: ".claude/adapters/loa_cheval/metering/pricing.py"
        symbol: "calculate_total_cost"
        note: "Sums component costs preserving conservation across input/output/reasoning"
      - repo: loa
        file: ".claude/adapters/tests/test_conservation_invariant.py"
        symbol: "TestConservationPropertyRange"
        note: "Range-based verification across 156 token/price sample pairs"

  - id: INV-002
    description: "Non-negative spend — daily_spend >= 0 at all times. The ledger never records negative costs."
    severity: critical
    category: bounded
    properties:
      - "daily_spend >= 0 at all times"
      - "read_daily_spend() >= 0 for any valid ledger file"
      - "No ledger entry has cost_micro_usd < 0"
    verified_in:
      - repo: loa
        file: ".claude/adapters/loa_cheval/metering/budget.py"
        symbol: "BudgetEnforcer"
        note: "pre_call_atomic reserves non-negative amounts only"
      - repo: loa
        file: ".claude/adapters/loa_cheval/metering/ledger.py"
        symbol: "update_daily_spend"
        note: "Adds positive cost to daily counter via flock-protected read-modify-write"
      - repo: loa
        file: ".claude/adapters/tests/test_conservation_invariant.py"
        symbol: "TestDailySpendNonNegative"
        note: "Verifies initial zero and monotonic increase"

  - id: INV-003
    description: "Deduplication — interaction_id uniqueness prevents double-counting. Each Deep Research interaction is recorded in the ledger at most once."
    severity: important
    category: idempotent
    properties:
      - "len(unique(interaction_ids)) == len(ledger_entries_for_interactions)"
      - "post_call with duplicate interaction_id is a no-op"
    verified_in:
      - repo: loa
        file: ".claude/adapters/loa_cheval/metering/budget.py"
        symbol: "BudgetEnforcer"
        note: "post_call tracks seen interaction_ids and skips duplicates"
      - repo: loa
        file: ".claude/adapters/loa_cheval/metering/ledger.py"
        symbol: "record_cost"
        note: "Delegates to append_ledger which writes atomically"
      - repo: loa
        file: ".claude/adapters/tests/test_budget_fallback.py"
        symbol: "TestAtomicPreCallPostCallZeroCost"
        note: "Verifies interaction_id deduplication in post_call"

  - id: INV-004
    description: "Budget monotonicity — daily spend counter only increases within a day, never decremented. Prevents budget evasion through counter manipulation."
    severity: critical
    category: monotonicity
    properties:
      - "daily_spend(t+1) >= daily_spend(t) within the same calendar day"
      - "update_daily_spend only adds, never subtracts"
    verified_in:
      - repo: loa
        file: ".claude/adapters/loa_cheval/metering/budget.py"
        symbol: "BudgetEnforcer"
        note: "post_call always adds positive cost to daily spend"
      - repo: loa
        file: ".claude/adapters/loa_cheval/metering/ledger.py"
        symbol: "update_daily_spend"
        note: "Adds entry_cost_micro to existing counter (never subtracts)"
      - repo: loa
        file: ".claude/adapters/tests/test_conservation_invariant.py"
        symbol: "TestDailySpendNonNegative"
        note: "test_spend_increases_monotonically verifies monotonic increase"

  - id: INV-005
    description: "Trust boundary — no model exceeds its trust_scopes at runtime. The resolver enforces that agent bindings respect declared trust boundaries."
    severity: critical
    category: bounded
    properties:
      - "For all agents: resolved_model.trust_scopes <= declared_trust_scopes"
      - "native_runtime agents cannot be overridden to remote models"
      - "Capability requirements must be satisfied by the resolved model"
    verified_in:
      - repo: loa
        file: ".claude/adapters/loa_cheval/routing/resolver.py"
        symbol: "resolve_execution"
        note: "Checks native_runtime guard and capability requirements"
      - repo: loa
        file: ".claude/adapters/loa_cheval/routing/resolver.py"
        symbol: "validate_bindings"
        note: "Pre-flight validation that all agent bindings are satisfiable"
      - repo: loa
        file: ".claude/data/model-permissions.yaml"
        symbol: "model_permissions"
        note: "Declares trust_scopes for all registered models"
      - repo: loa
        file: ".claude/adapters/tests/test_trust_scopes.py"
        symbol: "TestTrustScopesSchema"
        note: "Validates all models have complete trust_scopes declarations"

  - id: INV-006
    description: "Feedback dampening — model_performance feedback loop is bounded by EMA dampening. Score cannot jump more than alpha_max * delta per observation, preventing runaway convergence or death spirals in the autopoietic loop."
    severity: important
    category: bounded
    properties:
      - "For any observation: |dampened_score - old_score| <= ALPHA_MAX * |new_score - old_score|"
      - "alpha = ALPHA_MIN + (ALPHA_MAX - ALPHA_MIN) * min(1, sample_count / RAMP)"
      - "Cold start (null old_score) returns new_score directly (no dampening)"
      - "Repeated identical observations converge to that value"
    verified_in:
      - repo: loa-dixie
        file: "app/src/services/reputation-service.ts"
        symbol: "computeDampenedScore"
        note: "Pure EMA function with alpha ramp from ALPHA_MIN to ALPHA_MAX"
      - repo: loa-dixie
        file: "app/src/services/reputation-service.ts"
        symbol: "handleModelPerformance"
        note: "Uses computeDampenedScore instead of raw score assignment"
      - repo: loa-dixie
        file: "app/src/services/reputation-service.ts"
        symbol: "handleQualitySignal"
        note: "Consistent dampening across both score-update paths"
      - repo: loa-dixie
        file: "app/src/services/__tests__/feedback-dampening.test.ts"
        symbol: "computeDampenedScore"
        note: "8 test cases verifying EMA properties, convergence, and outlier dampening"

  - id: INV-007
    description: "Session-scoped governance — MutationLog is explicitly session-scoped with unique sessionId. Governance mutations are traceable to their originating session."
    severity: important
    category: traceability
    properties:
      - "Each MutationLog instance has a unique sessionId (UUID)"
      - "sessionId is immutable within a session (stable across appends)"
      - "getGovernedState().session_id links governance metadata to the active session"
    verified_in:
      - repo: loa-dixie
        file: "app/src/services/governance-mutation.ts"
        symbol: "MutationLog"
        note: "Session-scoped with readonly sessionId, optional MutationLogPersistence"
      - repo: loa-dixie
        file: "app/src/services/__tests__/governance-mutation.test.ts"
        symbol: "MutationLog session lifecycle"
        note: "Verifies sessionId uniqueness, stability, and governed state integration"

  - id: INV-008
    description: "Governance isomorphism — all governed resources implement the GovernedResource<T> protocol with identity, state transitions, invariant verification, and tamper-evident audit trail. The Kubernetes CRD moment: every governed resource in the ecosystem shares one governance primitive."
    severity: important
    category: structural
    properties:
      - "Every GovernedResource has resourceId, resourceType (identity)"
      - "Every GovernedResource exposes current state and monotonic version"
      - "transition(event, actorId) returns TransitionResult with success/failure discrimination"
      - "verify(invariantId) returns InvariantResult with satisfied/detail"
      - "verifyAll() covers all declared invariants for the resource"
      - "auditTrail is Readonly<AuditTrail> with hash chain integrity"
      - "mutationLog is ReadonlyArray<GovernanceMutation> with actor attribution"
      - "≥2 resource types implement the protocol (reputation, scoring-path)"
    verified_in:
      - repo: loa-dixie
        file: "app/src/services/governed-resource.ts"
        symbol: "GovernedResource<TState, TEvent, TInvariant>"
        note: "Interface definition with GovernedResourceBase abstract class"
      - repo: loa-dixie
        file: "app/src/services/reputation-service.ts"
        symbol: "ReputationService implements GovernedResource"
        note: "Reputation resource with INV-006 (dampening bounds) and INV-007 (session scope)"
      - repo: loa-dixie
        file: "app/src/services/scoring-path-tracker.ts"
        symbol: "ScoringPathTracker implements GovernedResource"
        note: "Scoring path resource with chain_integrity, cross_chain_consistency, checkpoint_coverage"
      - repo: loa-dixie
        file: "app/src/services/governor-registry.ts"
        symbol: "GovernorRegistry.verifyAllResources"
        note: "System-level verification across all registered GovernedResource instances"
      - repo: loa-dixie
        file: "app/src/services/__tests__/autopoietic-loop-v2.test.ts"
        symbol: "GovernedResource.verifyAll() covers all resources"
        note: "Integration test proving both implementations satisfy all invariants"

  - id: INV-009
    description: "Knowledge freshness — freshness_score decreases monotonically between ingestion events via exponential decay (lambda = 0.023, ~30 day half-life). Re-ingestion resets score to 1.0."
    severity: important
    category: bounded
    properties:
      - "freshness_score(t+1) <= freshness_score(t) when no ingestion event occurs between t and t+1"
      - "score(t) = exp(-lambda * days_since_refresh) where lambda = 0.023"
      - "Re-ingestion resets score to 1.0 and state to 'fresh'"
    verified_in:
      - repo: loa-dixie
        file: "app/src/services/knowledge-governor.ts"
        symbol: "computeFreshnessDecay"
        note: "Exponential decay computation with configurable lambda"
      - repo: loa-dixie
        file: "app/src/services/knowledge-governor.ts"
        symbol: "verifyFreshnessBound"
        note: "Invariant checker verifies monotonic decay between ingestion events"
      - repo: loa-dixie
        file: "app/tests/unit/knowledge-governor.test.ts"
        symbol: "INV-009 freshness bound"
        note: "Tests decay computation, state transitions, and re-ingestion reset"

  - id: INV-010
    description: "Citation integrity — citation count does not exceed the number of known sources in the corpus. Ensures citation claims are bounded by available evidence."
    severity: important
    category: referential
    properties:
      - "item.citation_count <= knownSources.size"
      - "verifyCitationIntegrity() returns satisfied: false when citation_count exceeds known source count"
    verified_in:
      - repo: loa-dixie
        file: "app/src/services/knowledge-governor.ts"
        symbol: "verifyCitationIntegrity"
        note: "Checks citation_count does not exceed knownSources.size"
      - repo: loa-dixie
        file: "app/tests/unit/knowledge-governor.test.ts"
        symbol: "INV-010 citation integrity"
        note: "Tests satisfied and violation cases"

  - id: INV-011
    description: "Chain integrity — computeChainBoundHash(entry, domainTag, previousHash) is deterministic and tamper-evident. Recomputing any entry's hash from its content and predecessor must match the stored hash."
    severity: critical
    category: integrity
    properties:
      - "For all entries e: recompute(e.content, e.previous_hash) == e.entry_hash"
      - "Modifying content OR previous_hash invalidates entry_hash"
      - "Chain is verifiable from genesis to tip in O(n) time"
    verified_in:
      - repo: loa-dixie
        file: "app/src/services/audit-trail-store.ts"
        symbol: "computeChainBoundHash"
        note: "Chain-bound hash: includes previous_hash in computation"
      - repo: loa-dixie
        file: "app/src/services/audit-trail-store.ts"
        symbol: "verifyIntegrity"
        note: "Walks chain from genesis, recomputes each hash"
      - repo: loa-dixie
        file: "app/src/services/scoring-path-tracker.ts"
        symbol: "verifyIntegrity"
        note: "Independent hash chain verification for scoring path"
      - repo: loa-dixie
        file: "app/tests/unit/audit-trail-store.test.ts"
        symbol: "verifyIntegrity"
        note: "Tests chain integrity and tamper detection"

  - id: INV-012
    description: "Three-witness quorum — the GovernorRegistry maintains >= 3 registered resource types, proving that the governance abstraction generalizes across independent domains rather than being incidental to a single use case."
    severity: important
    category: structural
    properties:
      - "governorRegistry.size >= 3 after initialization"
      - "At least 3 distinct resourceType values registered"
      - "verifyAllGovernors() returns health for all 3+ witnesses"
    verified_in:
      - repo: loa-dixie
        file: "app/src/services/governor-registry.ts"
        symbol: "verifyAllGovernors"
        note: "System-level verification across all registered governors"
      - repo: loa-dixie
        file: "app/tests/integration/governance-three-witness.test.ts"
        symbol: "registers all three witnesses"
        note: "Integration test proving 3 governors registered with health"
      - repo: loa-dixie
        file: "app/src/services/__tests__/autopoietic-loop-v2.test.ts"
        symbol: "GovernedResource.verifyAll()"
        note: "Proves all resource implementations satisfy invariants"
