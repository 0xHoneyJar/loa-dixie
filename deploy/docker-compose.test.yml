version: "3.9"

# Integration test environment — spins up dixie-bff with a mock loa-finn
# Usage: docker compose -f deploy/docker-compose.test.yml up --build --abort-on-container-exit

services:
  # Mock loa-finn — lightweight Hono server returning canned responses
  mock-finn:
    build:
      context: ../app
      dockerfile: ../deploy/Dockerfile
    environment:
      PORT: "4000"
      FINN_URL: "http://localhost:4000"
      NODE_ENV: test
      ADMIN_KEY: test-admin-key
      JWT_PRIVATE_KEY: test-jwt-secret-at-least-32-chars-long
    command: ["node", "-e", "
      const { serve } = require('@hono/node-server');
      const { Hono } = require('hono');
      const app = new Hono();
      app.get('/api/health', (c) => c.json({ status: 'ok', version: '1.0.0' }));
      app.get('/api/identity/oracle', (c) => c.json({
        nftId: 'oracle', name: 'The Oracle',
        damp96_summary: { archetype: 'sage' }, beauvoir_hash: null
      }));
      app.post('/api/sessions', (c) => c.json({ sessionId: 'test-sess-001' }));
      app.get('/api/sessions', (c) => c.json([]));
      serve({ fetch: app.fetch, port: 4000 });
    "]
    ports:
      - "4100:4000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/api/health"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Dixie BFF — the service under test
  dixie-bff:
    build:
      context: ../app
      dockerfile: ../deploy/Dockerfile
    environment:
      PORT: "3001"
      FINN_URL: "http://mock-finn:4000"
      NODE_ENV: test
      CORS_ORIGINS: "*"
      ADMIN_KEY: test-admin-key
      JWT_PRIVATE_KEY: test-jwt-secret-at-least-32-chars-long
      RATE_LIMIT_RPM: "1000"
    ports:
      - "3101:3001"
    depends_on:
      mock-finn:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/api/health"]
      interval: 5s
      timeout: 3s
      retries: 5
