# Advisory workflow — requires live staging infrastructure (PostgreSQL, Redis, NATS, loa-finn).
# Will fail in CI-only context. Use workflow_dispatch to run manually when staging is available.
# See: Phase 0.7 in loa-finn #66 (Command Deck — Staging Deployment Sequence)
name: E2E Smoke Tests (Advisory)

on:
  pull_request:
    branches: [main]
    paths:
      - 'app/**'
      - 'deploy/**'
      - 'tests/e2e/**'
  workflow_dispatch:

jobs:
  e2e:
    name: Staging Smoke Tests (Advisory)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: app/package-lock.json

      - name: Install dependencies
        working-directory: app
        run: npm ci

      - name: Build dixie-bff
        working-directory: app
        run: npm run build

      - name: Start staging compose
        run: |
          cp .env.example deploy/.env.staging
          # Override with CI-safe defaults
          echo "DIXIE_JWT_PRIVATE_KEY=$(openssl rand -hex 32)" >> deploy/.env.staging
          echo "POSTGRES_PASSWORD=ci-test-password" >> deploy/.env.staging
          docker compose -f deploy/docker-compose.staging.yml --env-file deploy/.env.staging up -d --wait
        timeout-minutes: 5

      - name: Wait for health
        run: |
          for i in $(seq 1 30); do
            if curl -sf http://localhost:3001/api/health | grep -q '"status"'; then
              echo "Health check passed"
              exit 0
            fi
            echo "Waiting for health... ($i/30)"
            sleep 2
          done
          echo "Health check failed"
          docker compose -f deploy/docker-compose.staging.yml logs dixie-bff --tail=50
          exit 1
        timeout-minutes: 3

      - name: Run E2E smoke tests
        working-directory: app
        run: npm run test:e2e

      - name: Collect logs on failure
        if: failure()
        run: |
          docker compose -f deploy/docker-compose.staging.yml logs --tail=100 > staging-logs.txt
          echo "=== Container Status ==="
          docker compose -f deploy/docker-compose.staging.yml ps

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: staging-logs
          path: staging-logs.txt

      - name: Teardown
        if: always()
        run: docker compose -f deploy/docker-compose.staging.yml down -v
