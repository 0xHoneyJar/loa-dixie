# Bridgebuilder Review â€” Iteration 2

**Bridge ID**: bridge-20260220-451207
**Iteration**: 2
**Verdict**: APPROVED

## Sprint 18 Fix Verification

All 7 fixes from Sprint 18 verified as correct and complete:

- **SEC-001**: Two-layer defense (config startup + runtime guard) is exemplary
- **SEC-002**: Path parameter validation applied consistently to all HTTP URL interpolation points
- **SEC-003**: Wallet bridge middleware is minimal, correct, and well-positioned
- **ARCH-002**: Zod schemas provide runtime validation where TypeScript generics are erased
- **RES-002**: Reconnect counter properly resets on successful WebSocket connection
- **CODE-003**: UUID message IDs eliminate collision risk
- **CODE-004**: OracleIdentityCard auth token works correctly

## Findings

<!-- bridge-findings-start -->
{
  "bridge_id": "bridge-20260220-451207",
  "iteration": 2,
  "verdict": "APPROVED",
  "findings": [
    {
      "id": "SEC-007",
      "severity": "MEDIUM",
      "category": "security",
      "title": "WebSocket upgrade handler does not validate session ID in URL path",
      "description": "In ws-upgrade.ts:45, the full client-supplied URL pathname is forwarded to loa-finn. The URL constructor normalizes path traversal, so ../../admin resolves to /admin upstream. The session ID portion is never validated with isValidPathParam().",
      "file": "app/src/ws-upgrade.ts",
      "line": 45,
      "recommendation": "Extract session ID from URL path and validate with isValidPathParam() before constructing upstream URL.",
      "effort": "small"
    },
    {
      "id": "ARCH-001",
      "severity": "MEDIUM",
      "category": "architecture",
      "title": "Header-bridging pattern duplicates wallet/requestId extraction across routes",
      "description": "Reading x-wallet-address and x-request-id is repeated in chat.ts, sessions.ts, ws-ticket.ts, identity.ts with slight inconsistencies in requestId extraction.",
      "file": "app/src/routes/chat.ts",
      "line": 55,
      "recommendation": "Extract getRequestContext(c) helper for consistent extraction.",
      "effort": "small"
    },
    {
      "id": "SEC-004",
      "severity": "LOW",
      "category": "security",
      "title": "Body-limit bypass via omitted Content-Length",
      "description": "Header-only check. Documented trade-off, acceptable for Phase 1.",
      "file": "app/src/middleware/body-limit.ts",
      "line": 15,
      "recommendation": "Add streaming body inspection as Phase 2 hardening item.",
      "effort": "medium"
    },
    {
      "id": "SEC-005",
      "severity": "LOW",
      "category": "security",
      "title": "Rate limiter trusts raw X-Forwarded-For",
      "description": "No trusted proxy depth validation. Acceptable behind reverse proxy.",
      "file": "app/src/middleware/rate-limit.ts",
      "line": 42,
      "recommendation": "Configure trusted proxy depth before public launch.",
      "effort": "small"
    },
    {
      "id": "SEC-006",
      "severity": "LOW",
      "category": "security",
      "title": "Audit log IP is spoofable via X-Forwarded-For",
      "description": "Same root cause as SEC-005 applied to audit log.",
      "file": "app/src/middleware/allowlist.ts",
      "line": 322,
      "recommendation": "Same fix as SEC-005.",
      "effort": "small"
    },
    {
      "id": "CODE-002",
      "severity": "LOW",
      "category": "code-quality",
      "title": "Duplicated error handling pattern in route handlers",
      "description": "The finnClient error check pattern repeated in chat.ts, sessions.ts.",
      "file": "app/src/routes/chat.ts",
      "line": 102,
      "recommendation": "Extract handleFinnError() helper. Low priority.",
      "effort": "trivial"
    }
  ],
  "summary": {
    "total": 11,
    "high": 0,
    "medium": 2,
    "low": 4,
    "praise": 5,
    "speculation": 0
  }
}
<!-- bridge-findings-end -->

## PRAISE Findings

- PRAISE-001: Excellent defense-in-depth on SEC-001 admin key fix
- PRAISE-002: Well-designed validation.ts module
- PRAISE-003: Wallet bridge middleware cleanly solves Hono sub-app boundary
- PRAISE-004: Circuit breaker in FinnClient is production-grade
- PRAISE-005: WebSocket ticket authentication pattern is well-implemented
