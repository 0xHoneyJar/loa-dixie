# Bridgebuilder Review â€” Iteration 1

**Bridge ID**: bridge-20260220-451207
**PR**: #2 (feature/dixie-mvp)
**Date**: 2026-02-21

## Executive Summary

The Dixie BFF is a well-structured Backend-For-Frontend that demonstrates strong architectural thinking across 17 sprints. The middleware pipeline's intentional ordering (communitarian governance), the circuit breaker implementation in FinnClient, the WebSocket ticket authentication pattern, and the Hounfour protocol alignment are all commendable.

Three HIGH-severity security findings must be addressed before production deployment:
- SEC-001: Admin API open when DIXIE_ADMIN_KEY is unset
- SEC-002: Path injection via user-controlled sessionId
- SEC-003: Wallet identity not propagated from JWT middleware to route handlers

## Findings Summary

| Severity | Count |
|----------|-------|
| HIGH | 3 |
| MEDIUM | 7 |
| LOW | 3 |
| PRAISE | 5 |
| SPECULATION | 1 |
| REFRAME | 1 |
| **Total** | **17** |

## Verdict: NEEDS_CHANGES

<!-- bridge-findings-start -->
```json
{
  "review_version": "1.0.0",
  "reviewer": "senior-architect",
  "reviewed_at": "2026-02-21T00:00:00Z",
  "pr": "feature/dixie-mvp",
  "findings": [
    {
      "id": "SEC-001",
      "title": "Admin API open when DIXIE_ADMIN_KEY is unset",
      "severity": "HIGH",
      "category": "security",
      "file": "app/src/config.ts:66",
      "description": "DIXIE_ADMIN_KEY defaults to empty string. safeEqual('', '') returns true via zero-length buffer comparison. Admin API is accessible without credentials when env var is not set.",
      "suggestion": "Validate adminKey is non-empty at startup or add early-return guard in admin middleware."
    },
    {
      "id": "SEC-002",
      "title": "Path injection via user-controlled sessionId in URL construction",
      "severity": "HIGH",
      "category": "security",
      "file": "app/src/routes/chat.ts:55",
      "description": "body.sessionId interpolated directly into URL path /api/sessions/${body.sessionId}/message. Malicious sessionId like ../../admin/allowlist would cause SSRF-adjacent path traversal to unintended finn endpoints.",
      "suggestion": "Validate sessionId against strict pattern /^[a-zA-Z0-9_-]+$/ before interpolation."
    },
    {
      "id": "SEC-003",
      "title": "Wallet identity not propagated from JWT middleware to route handlers",
      "severity": "HIGH",
      "category": "security",
      "file": "app/src/server.ts:96",
      "description": "JWT middleware stores wallet via c.set('wallet'), but route handlers read c.req.header('x-wallet-address') which is never set by any middleware. Wallet is never forwarded to finn in JWT-authenticated flows.",
      "suggestion": "Add bridge middleware in server.ts that copies c.get('wallet') to x-wallet-address header, matching the pattern in ws-ticket.test.ts."
    },
    {
      "id": "SEC-004",
      "title": "Body-limit middleware bypassable when Content-Length header is omitted",
      "severity": "MEDIUM",
      "category": "security",
      "file": "app/src/middleware/body-limit.ts:15-16",
      "description": "Only checks Content-Length header. Chunked transfer encoding bypasses the check entirely.",
      "suggestion": "Use Hono's built-in bodyLimit middleware or add streaming byte-counting."
    },
    {
      "id": "SEC-005",
      "title": "Rate limiter keyed on spoofable x-forwarded-for header",
      "severity": "MEDIUM",
      "category": "security",
      "file": "app/src/middleware/rate-limit.ts:42",
      "description": "Unauthenticated rate limiting uses client-supplied X-Forwarded-For, trivially rotatable to bypass limits.",
      "suggestion": "Use socket-level IP or configure trusted proxy depth."
    },
    {
      "id": "SEC-006",
      "title": "IP address in audit log sourced from spoofable header",
      "severity": "MEDIUM",
      "category": "security",
      "file": "app/src/middleware/allowlist.ts:322",
      "description": "Audit entries record X-Forwarded-For as IP, making audit trail unreliable for forensics.",
      "suggestion": "Log both raw XFF and socket-level IP."
    },
    {
      "id": "RES-001",
      "title": "Module-level cached health state shared across app instances",
      "severity": "MEDIUM",
      "category": "resilience",
      "file": "app/src/routes/health.ts:9",
      "description": "Module-level caches shared across test suites. Also caches 'unreachable' for 10s extending failure window.",
      "suggestion": "Move caches into route factory closure or cache service."
    },
    {
      "id": "RES-002",
      "title": "WebSocket reconnect counter never resets on success",
      "severity": "MEDIUM",
      "category": "resilience",
      "file": "web/src/lib/ws.ts:88-93",
      "description": "reconnectAttempts is monotonic. After 3 successful reconnects, 4th disconnect won't reconnect.",
      "suggestion": "Reset reconnectAttempts to 0 on successful WebSocket open."
    },
    {
      "id": "ARCH-001",
      "title": "Hono sub-app typed context workaround via headers is fragile",
      "severity": "MEDIUM",
      "category": "architecture",
      "file": "app/src/routes/chat.ts:6-16",
      "description": "Header-bridging pattern duplicated across 4 route files. No central bridge middleware exists.",
      "suggestion": "Consolidate into single middleware. Evaluate Hono v4.7+ context inheritance."
    },
    {
      "id": "ARCH-002",
      "title": "No runtime validation on JSON body parsing",
      "severity": "MEDIUM",
      "category": "architecture",
      "file": "app/src/routes/chat.ts:37",
      "description": "c.req.json<T>() provides zero runtime validation. Non-string prompt would throw at .trim().",
      "suggestion": "Add Zod/Valibot schemas for runtime body validation."
    },
    {
      "id": "CODE-001",
      "title": "No integration tests for JWT-authenticated flow",
      "severity": "MEDIUM",
      "category": "code_quality",
      "file": "app/tests/unit/chat.test.ts",
      "description": "JWT auth path never tested end-to-end. Only API key path tested. Would have caught SEC-003.",
      "suggestion": "Add JWT-flow integration tests verifying wallet propagation."
    },
    {
      "id": "CODE-002",
      "title": "Duplicated error handling pattern across proxy routes",
      "severity": "LOW",
      "category": "code_quality",
      "file": "app/src/routes/chat.ts:87-96",
      "description": "Same 10-line try/catch pattern copied in chat.ts and sessions.ts (3 copies).",
      "suggestion": "Extract handleFinnError utility or global error handler middleware."
    },
    {
      "id": "CODE-003",
      "title": "Frontend message IDs use Date.now() -- not collision-safe",
      "severity": "LOW",
      "category": "code_quality",
      "file": "web/src/hooks/useChat.ts:43",
      "description": "Two messages in same millisecond get same ID, causing React key collision.",
      "suggestion": "Use crypto.randomUUID()."
    },
    {
      "id": "CODE-004",
      "title": "OracleIdentityCard fetches without auth token",
      "severity": "LOW",
      "category": "code_quality",
      "file": "web/src/components/OracleIdentityCard.tsx:32",
      "description": "Uses raw fetch() instead of api module's apiFetch, bypassing auth header injection.",
      "suggestion": "Use the api module's fetch wrapper."
    }
  ]
}
```
<!-- bridge-findings-end -->
